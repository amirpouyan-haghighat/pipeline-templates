name: semantic-release
description: Shared semantic-release steps for tagging and syncing release notes.
inputs:
  release_branch:
    description: Branch to treat as the release branch.
    required: false
    default: main
  repo_token:
    description: Token with repo scope used by semantic-release.
    required: true
  github_token:
    description: GitHub token used for managing release notes.
    required: true
outputs:
  new_release_version:
    description: Version generated by semantic-release.
    value: ${{ steps.semantic.outputs.new_release_version }}
  new_release_published:
    description: Indicates whether a release was published.
    value: ${{ steps.semantic.outputs.new_release_published }}
  new_release_git_tag:
    description: Git tag of the published release.
    value: ${{ steps.semantic.outputs.new_release_git_tag }}
runs:
  using: composite
  steps:
    - name: Prepare semantic-release config
      shell: bash
      env:
        RELEASE_BRANCH: ${{ inputs.release_branch }}
      run: |
        cat <<EOF > .releaserc.json
        {
          "branches": [
            "${RELEASE_BRANCH}"
          ],
          "plugins": [
            [
              "@semantic-release/commit-analyzer",
              {
                "releaseRules": [
                  {"type": "feat", "release": "minor"},
                  {"type": "fix", "release": "patch"},
                  {"type": "perf", "release": "patch"},
                  {"type": "chore", "release": "patch"}
                ]
              }
            ],
            [
              "@semantic-release/release-notes-generator",
              {
                "preset": "conventionalcommits"
              }
            ],
            [
              "@semantic-release/github",
              {
                "addReleases": "bottom"
              }
            ]
          ]
        }
        EOF

    - name: Run Semantic Release
      id: semantic
      uses: cycjimmy/semantic-release-action@v5
      with:
        extra_plugins: |
          conventional-changelog-conventionalcommits@9.1.0
      env:
        GITHUB_TOKEN: ${{ inputs.repo_token }}

    - name: Sync release body with GitHub auto notes
      if: steps.semantic.outputs.new_release_published == 'true'
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}
        NEW_TAG: ${{ steps.semantic.outputs.new_release_git_tag }}
        REPOSITORY: ${{ github.repository }}
      run: |
        set -euo pipefail

        git fetch --tags --force
        PREV_TAG=$(git tag --sort=-version:refname | grep -v "^${NEW_TAG}$" | head -n 1 || true)

        payload=$(jq -n --arg tag "${NEW_TAG}" --arg prev "${PREV_TAG}" '
          {tag_name: $tag} + (if $prev | length > 0 then {previous_tag_name: $prev} else {} end)
        ')

        response=$(curl -sS -X POST \
          -H "Authorization: Bearer ${GITHUB_TOKEN}" \
          -H "Accept: application/vnd.github+json" \
          https://api.github.com/repos/${REPOSITORY}/releases/generate-notes \
          -d "${payload}")

        body=$(echo "${response}" | jq -r '.body')
        if [ -z "${body}" ] || [ "${body}" = "null" ]; then
          echo "GitHub did not return generated notes. API response:" >&2
          echo "${response}" >&2
          exit 1
        fi

        echo "GitHub generated release notes:"
        echo "${body}"

        release_response=$(curl -sS \
          -H "Authorization: Bearer ${GITHUB_TOKEN}" \
          -H "Accept: application/vnd.github+json" \
          https://api.github.com/repos/${REPOSITORY}/releases/tags/${NEW_TAG})

        release_id=$(echo "${release_response}" | jq -r '.id')
        if [ -z "${release_id}" ] || [ "${release_id}" = "null" ]; then
          echo "Unable to find release ID for tag ${NEW_TAG}. API response:" >&2
          echo "${release_response}" >&2
          exit 1
        fi

        curl -sS -X PATCH \
          -H "Authorization: Bearer ${GITHUB_TOKEN}" \
          -H "Accept: application/vnd.github+json" \
          https://api.github.com/repos/${REPOSITORY}/releases/${release_id} \
          -d "$(jq -n --arg body "${body}" '{body: $body}')"

        echo "Release ${NEW_TAG} updated with GitHub generated notes."
